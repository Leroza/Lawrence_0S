<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leroza.dev - Retro Portfolio [CRT v3]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Retro Terminal Font -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        /* Define Custom Colors for Theme */
        :root {
            --color-khaki: #C3B091; /* Aged Amber/Terminal Main Color */
            --color-maroon: #500000; /* Deep Background Accent */
            --color-black: #000000;
            --color-white: #FFFFFF;
            --color-orange: #ff8c00; /* Action/Highlight Color */
            --color-danger: #ff0000;
            --color-safe: #00ff00;
        }

        /*
        * 1. Global Reset & Scroll Snap Setup (Retro Font Applied)
        */
        body {
            cursor: none; /* Hide default cursor */
            font-family: 'VT323', monospace;
            background-color: var(--color-black); /* True black background for CRT effect */
            color: var(--color-khaki); /* Main text color */
            height: 100vh;
            /* Scroll ability maintained by browser auto-overflow */
            scroll-snap-type: y mandatory;
            padding-bottom: 70px; 
            position: relative;
            overflow-x: hidden; /* Prevent horizontal scroll on mobile */
        }

        section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: start;
            padding: 6rem 1rem; /* Increased vertical padding for maximized space */
            /* Retro glow/shadow: stronger glow on the text */
            text-shadow: 0 0 5px var(--color-khaki), 0 0 10px rgba(195, 176, 145, 0.4);
        }
        
        /* ----------------------------------------------------
        * CRT SCREEN OVERLAY (Scanlines, Curvature, Bloom)
        * ---------------------------------------------------- */
        #crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10000;
            opacity: 0.9;
            box-shadow: 
                inset 0 0 100px rgba(0,0,0,0.7), 
                0 0 10px rgba(0, 0, 0, 0.8);
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.2),
                    rgba(0, 0, 0, 0.3) 1px,
                    transparent 1px,
                    transparent 2px
                );
            filter: blur(0.3px) contrast(1.1);
            transform: perspective(1000px) rotateX(0deg) rotateY(0deg); 
        }

        /* ----------------------------------------------------
        * GLITCH IDENTITY (Added back from previous version)
        * ---------------------------------------------------- */
        @keyframes glitchFlicker {
            0%, 70% { text-shadow: 0 0 5px var(--color-maroon), 0 0 10px rgba(80, 0, 0, 0.4); transform: translate(0, 0); }
            75% { text-shadow: 2px 0px 5px var(--color-danger), -2px 0px 5px rgb(0, 255, 255); transform: translate(1px, 0.5px); }
            80% { text-shadow: -1px 1px 5px rgb(255, 0, 255), 1px -1px 5px var(--color-safe); transform: translate(-1.5px, -1px); }
            85% { text-shadow: 1px -1px 5px var(--color-orange), -1px 1px 5px var(--color-white); transform: translate(0.5px, 0.5px); }
            90%, 100% { text-shadow: 0 0 5px var(--color-maroon), 0 0 10px rgba(80, 0, 0, 0.4); transform: translate(0, 0); }
        }
        .constant-glitch { animation: glitchFlicker 1.2s infinite steps(1); }
        #glitching-identity { color: var(--color-khaki); z-index: 51; padding: 10px; }

        /*
        * 2. The Pixel Plane Cursor (FIXED for chunky pixel art)
        */
        #plane-cursor {
            position: fixed;
            width: 32px; /* Increased size for chunky pixel art */
            height: 32px;
            pointer-events: none;
            z-index: 10001;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            transition: transform 0.05s linear;
        }
        
        .plane-body {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px; /* Core pixel size */
            height: 2px;
            background-color: var(--color-khaki); 
            /* Detailed 5x5 pixel plane structure using 4px offsets */
            box-shadow: 
                /* Main Body Center Column */
                0 -8px var(--color-khaki), 0 -4px var(--color-khaki), 
                0 4px var(--color-khaki), 0 8px var(--color-khaki),
                
                /* Main Body Left/Right (1 pixel wide) */
                -4px 0 var(--color-khaki), 4px 0 var(--color-khaki),
                -8px 0 var(--color-khaki), 8px 0 var(--color-khaki),
                
                /* Wings (Top spread, 7 wide) */
                -12px 4px var(--color-khaki), 12px 4px var(--color-khaki),
                -8px 4px var(--color-khaki), 8px 4px var(--color-khaki),
                -4px 4px var(--color-khaki), 4px 4px var(--color-khaki),
                
                /* Firing Tip (2 pixels higher than center) */
                0 -12px var(--color-khaki),
                /* Firing Port Indicator (3 pixels higher) - Brighter for bullet origin */
                0 -16px var(--color-orange); 
            transform: translate(-50%, -50%);
        }

        /*
        * 3. Bullet Styling
        */
        .bullet {
            position: fixed;
            width: 8px;
            height: 8px;
            background-color: var(--color-orange); 
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 0 10px var(--color-orange), 0 0 30px var(--color-orange); 
            opacity: 1;
            transition: opacity 0.1s;
        }

        /*
        * 4. Text Spans (Destructible Targets)
        */
        .destructible-text span {
            display: inline-block;
            transition: opacity 0.3s, transform 0.3s, color 0.1s;
            line-height: 1.2;
            will-change: transform, color;
        }
        
        .destructible-text span:hover {
            transform: translateY(-2px) scale(1.05);
            color: var(--color-orange); 
            z-index: 10;
        }

        .destroyed {
            opacity: 0 !important;
            transform: scale(0.5) translateY(-20px);
        }

        /*
        * 4.1. Chaotic Animation for Skills
        */
        @keyframes gruggyWobble {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-1px, 0px) rotate(-0.5deg); }
            50% { transform: translate(1px, -1px) rotate(0.5deg); }
            75% { transform: translate(-1px, 1px) rotate(-0.2deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }
        .chaotic-skill { animation: gruggyWobble 1s infinite alternate; }

        /*
        * 4.2. Explosion Flash Animation
        */
        @keyframes flashExplosion {
            0% { opacity: 0; background-color: transparent; }
            5% { opacity: 1; background-color: var(--color-orange); }
            10% { opacity: 1; background-color: var(--color-white); }
            20% { opacity: 0; background-color: transparent; }
            100% { opacity: 0; background-color: transparent; }
        }
        #explosion-flash { z-index: 10002; }
        .do-explosion { animation: flashExplosion 0.5s forwards; }

        /* ----------------------------------------------------
        * 5. Retro Life Bar / HUD Styles
        * ---------------------------------------------------- */
        .hud-bar {
            border-top: 6px solid var(--color-khaki);
            border-bottom: 6px solid var(--color-khaki);
            background-color: var(--color-maroon);
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.5); 
        }
        .health-bar-frame { height: 18px; }

        /* 5.1 SKILLS HUD BUTTON STYLES */
        .skill-button {
            border: 3px solid var(--color-khaki); 
            background-color: var(--color-maroon);
            color: var(--color-khaki);
            padding: 2px 6px;
            box-shadow: 2px 2px 0 var(--color-black), -2px -2px 0 var(--color-maroon);
        }
        .skill-button:active, .skill-button.pressed {
            background-color: var(--color-orange); 
            color: var(--color-white);
            box-shadow: inset 2px 2px 0 var(--color-black), inset -2px -2px 0 var(--color-white);
        }
        .skill-button.on {
            background-color: var(--color-white);
            color: var(--color-maroon);
            box-shadow: 0 0 8px var(--color-orange); 
        }

        /*
        * 5.2 Folder Item Styling (Increased Size)
        */
        .folder-item {
            font-size: 3rem; /* Increased size */
            padding: 12px; /* Increased padding */
            color: var(--color-maroon);
            border-bottom: 2px dashed rgba(80, 0, 0, 0.3);
        }
        .folder-item:hover {
            color: var(--color-white); 
            background-color: rgba(80, 0, 0, 0.6); 
            text-shadow: 0 0 5px var(--color-white);
        }

        /* ----------------------------------------------------
        * 6. Typography Overrides for Maximized Spacing (FIXED/INCREASED)
        * ---------------------------------------------------- */
        .skill-matrix-section {
            box-shadow: 0 0 20px rgba(195,176,145,0.8), 0 0 5px rgba(255,255,255,0.8);
            max-width: 90%;
            width: 100%;
            border: 6px solid var(--color-khaki);
            background-color: var(--color-maroon);
            padding: 2rem; /* Ensure padding is applied */
        }
        
        .max-type-title {
            font-size: 10rem; /* 160px */
            line-height: 0.9;
            margin-bottom: 2rem;
        }
        @media (min-width: 768px) {
            .max-type-title {
                font-size: 14rem; /* 224px */
            }
        }

        .max-type-subtitle {
            font-size: 5rem; /* 80px */
            line-height: 1.1;
            margin-top: 3rem; 
        }
        @media (min-width: 768px) {
             .max-type-subtitle {
                font-size: 7rem; /* 112px */
            }
        }
        
        .max-type-skill-label {
            font-size: 4rem; /* 64px */
            line-height: 1.1;
        }
        
        /* FIXED: Improved spacing for skills matrix items */
        .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        
        .skill-name {
            flex: 1;
            text-align: left;
            margin-right: 20px;
            word-break: break-word;
        }
        
        .skill-percent {
            flex-shrink: 0;
            text-align: right;
            white-space: nowrap;
        }
        
        /* FIXED: Improved responsive behavior */
        @media (max-width: 768px) {
            .max-type-title {
                font-size: 6rem;
                line-height: 1;
            }
            
            .max-type-subtitle {
                font-size: 3rem;
                line-height: 1.2;
            }
            
            .max-type-skill-label {
                font-size: 2.5rem;
            }
            
            .skill-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .skill-percent {
                margin-top: 10px;
                align-self: flex-end;
            }
            
            .folder-item {
                font-size: 2rem;
            }
        }
        
        /* FIXED: Improved section spacing */
        #skills-matrix {
            padding-top: 8rem;
            padding-bottom: 8rem;
        }
        
        #work {
            padding-top: 8rem;
            padding-bottom: 8rem;
        }
    </style>
</head>
<body>

    <!-- CRT Overlay for Scanlines and Curvature Effect -->
    <div id="crt-overlay" aria-hidden="true"></div>

    <!-- The Custom Plane Cursor -->
    <div id="plane-cursor" aria-hidden="true">
        <div class="plane-body"></div>
    </div>

    <!-- Bullet Container -->
    <div id="bullet-container"></div>

    <!-- Confetti Container (Kept for shatter effect pieces) -->
    <div id="confetti-container"></div>
    
    <!-- Explosion Flash Overlay -->
    <div id="explosion-flash"></div>

    <!-- Victory Glitch Overlay -->
    <div id="victory-glitch"></div>

    <!-- NEW: Project Preview Overlay (Fixed to screen) -->
    <div id="project-preview" class="fixed top-0 left-0 hidden z-20 pointer-events-none opacity-0">
        <div id="preview-box" class="p-2 border-4 border-[var(--color-orange)] bg-[var(--color-black)] text-[var(--color-khaki)] shadow-lg" style="width: 400px;">
            <p class="text-xl mb-2 text-center border-b border-[var(--color-khaki)]">FILE\_PREVIEW.IMG</p>
            <img id="preview-image" src="" alt="Project Preview Placeholder" class="w-full h-auto" onerror="this.onerror=null;this.src='https://placehold.co/400x250/ff0000/ffffff?text=ERROR'; document.getElementById('preview-box').style.width='400px'">
        </div>
    </div>

    <!-- NEW: Top-Left Glitching Identity (Isolated from HUD) -->
    <div id="glitching-identity" class="fixed top-0 left-0 text-xl md:text-3xl font-extrabold tracking-widest hidden sm:block constant-glitch">
        LEROZA.<span id="glitch-title" class="text-[var(--color-orange)]">DEV</span>
    </div>

    <!-- Header / LIFEBAR HUD (Fixed to the BOTTOM) -->
    <header id="hud-bar" class="fixed bottom-0 left-0 right-0 z-50 p-3 hud-bar">
        <nav class="flex justify-between items-center max-w-7xl mx-auto w-full text-lg">
            
            <!-- Group 1 (Left: HP & Targets) -->
            <div class="flex items-center space-x-4 md:space-x-6 mx-auto md:mx-0">
                
                <!-- Health Bar Visual -->
                <div class="flex items-center space-x-2">
                    <span class="text-xl text-[var(--color-maroon)]">TARGETS:</span>
                    <div class="health-bar-frame w-20 md:w-28">
                        <div id="health-fill" class="health-bar-fill" style="width: 100%;"></div>
                    </div>
                </div>

                <!-- Skills HUD -->
                <div id="skills-hud" class="hidden sm:flex space-x-2 text-sm font-bold">
                    <span id="skill-1" class="skill-button cursor-pointer on">[1] SPREAD: OFF</span>
                    <span id="skill-2" class="skill-button cursor-pointer">[2] REPAIR (5%)</span>
                    <span id="skill-3" class="skill-button cursor-pointer on">[3] GUN: ACTIVE</span>
                </div>
            </div>

            <!-- Group 2 (Right: Navigation Links) -->
            <div class="flex space-x-4 md:space-x-6 text-base font-bold">
                <a href="#intro" class="text-[var(--color-maroon)] hover:text-[var(--color-orange)] transition duration-200">[ HOME ]</a>
                <a href="#skills-matrix" class="text-[var(--color-maroon)] hover:text-[var(--color-orange)] transition duration-200">[ MATRIX ]</a>
                <a href="#work" class="text-[var(--color-maroon)] hover:text-[var(--color-orange)] transition duration-200">[ PROJECTS ]</a>
                <a href="#contact" class="text-[var(--color-maroon)] hover:text-[var(--color-orange)] transition duration-200">[ CONNECT ]</a>
            </div>
        </nav>
    </header>

    <!-- SECTION 1: INTRO (Maroon Background) -->
    <section id="intro" class="bg-[var(--color-maroon)]">
        <div class="text-center max-w-7xl px-4">
            
            <h2 class="max-type-title font-extrabold text-[var(--color-khaki)] destructible-text" data-section="intro">
                LEROZA.DEV 
            </h2>
            <p class="max-type-subtitle font-light text-[var(--color-white)] destructible-text" data-section="intro">
                RETRO-TERMINAL // INTERFACE.
            </p>
            <p class="max-type-subtitle font-light text-[var(--color-white)] mt-8 text-2xl md:text-4xl destructible-text" data-section="intro">
                DESTROY ALL TARGETS TO UNLOCK FINAL SCORE.
            </p>
        </div>
    </section>

    <!-- NEW SECTION: SKILL MATRIX (Khaki Background) - Dedicated Section -->
    <section id="skills-matrix" class="bg-[var(--color-khaki)]">
        <div class="text-center max-w-7xl px-4 text-[var(--color-maroon)]">
            <h2 class="max-type-title font-extrabold mb-12 destructible-text" data-section="skills">
                SKILL_MATRIX
            </h2>
            
            <div class="skill-matrix-section text-left w-full md:w-[900px] p-8 md:p-12 relative">
                
                <h3 class="max-type-subtitle font-extrabold text-[var(--color-khaki)] mb-8 border-b-4 border-b-[var(--color-khaki)] pb-2 text-[var(--color-khaki)]">
                    PROGRAMMING // CAPACITIES
                </h3>
                
                <div id="skill-list" class="grid grid-cols-1 gap-x-16 gap-y-10"> 
                    <!-- Skills will be populated here by JS -->
                </div>

                <p class="max-type-subtitle font-extralight text-[var(--color-khaki)] mt-12 text-[var(--color-khaki)]">
                    TARGET PERCENTAGES.
                </p>
            </div>
        </div>
    </section>

    <!-- SECTION 3: WORK (Maroon Background) -->
    <section id="work" class="bg-[var(--color-maroon)]">
        <div class="text-center max-w-7xl px-4 text-[var(--color-khaki)]">
            <h2 class="max-type-title font-extrabold mb-12 destructible-text" data-section="work">
                PROJECT_LOG
            </h2>
            <!-- New Folder List Structure -->
            <div id="project-folder-list" class="mt-16 text-left max-w-3xl mx-auto space-y-4">
                
                <div class="folder-item destructible-text max-type-skill-label bg-[var(--color-khaki)] text-[var(--color-maroon)]" data-section="work" 
                    onmouseover="showPreview(event, 'https://placehold.co/400x250/500000/C3B091?text=GAME+UI+SCREENSHOT')"
                    onmouseout="hidePreview()">
                    > [DIR] GAME\_UI\_V1 (2024)
                </div>
                
                <div class="folder-item destructible-text max-type-skill-label bg-[var(--color-khaki)] text-[var(--color-maroon)]" data-section="work" 
                    onmouseover="showPreview(event, 'https://placehold.co/400x250/C3B091/500000?text=WEB+APP+DASHBOARD')"
                    onmouseout="hidePreview()">
                    > [DIR] WEB\_APP\_V2 (2023)
                </div>
                
                <div class="folder-item destructible-text max-type-skill-label bg-[var(--color-khaki)] text-[var(--color-maroon)]" data-section="work" 
                    onmouseover="showPreview(event, 'https://placehold.co/400x250/ff8c00/FFFFFF?text=3D+MODEL+RENDER')"
                    onmouseout="hidePreview()">
                    > [DIR] 3D\_ASSETS\_PACK (2022)
                </div>
                
                <div class="folder-item destructible-text max-type-skill-label bg-[var(--color-khaki)] text-[var(--color-maroon)]" data-section="work" 
                    onmouseover="showPreview(event, 'https://placehold.co/400x250/00ff00/500000?text=AI+BOT+INTEGRATION')"
                    onmouseout="hidePreview()">
                    > [FILE] AI\_ENGINE\_V1.EXE
                </div>
                
            </div>
        </div>
    </section>

    <!-- SECTION 4: CONTACT (Khaki Background) -->
    <section id="contact" class="bg-[var(--color-khaki)]">
        <div class="text-center max-w-7xl px-4 text-[var(--color-maroon)]">
            <h2 class="max-type-title font-extrabold mb-12 destructible-text" data-section="contact">
                GAME OVER.
            </h2>
            <p class="max-type-subtitle font-light text-[var(--color-maroon)] mt-8 destructible-text" data-section="contact">
                LEROZA@DEV.IO
            </p>
            <div class="mt-16">
                <!-- Contact Button: Hard lines, orange hover, inverse colors -->
                <a href="mailto:leroza@dev.io" class="inline-block px-10 py-6 text-3xl font-bold bg-[var(--color-maroon)] text-[var(--color-khaki)] rounded-none shadow-2xl border-4 border-white hover:bg-[var(--color-orange)] hover:text-white transition duration-300 transform hover:scale-105">
                    INITIATE_CONTACT
                </a>
            </div>
        </div>
    </section>

    <script>
        // --- Game Setup and Constants ---
        const planeCursor = document.getElementById('plane-cursor');
        const bulletContainer = document.getElementById('bullet-container');
        const healthFillElement = document.getElementById('health-fill');
        const confettiContainer = document.getElementById('confetti-container');
        const skillListElement = document.getElementById('skill-list');
        const explosionFlash = document.getElementById('explosion-flash');
        const glitchTitleEl = document.getElementById('glitch-title');
        
        // Preview elements
        const projectPreview = document.getElementById('project-preview');
        const previewImage = document.getElementById('preview-image');
        const previewBox = document.getElementById('preview-box');

        // UPDATED CONSTANTS for shooting fix
        const BULLET_SPEED = 20; 
        const FIRE_RATE = 100; 
        const REPAIR_AMOUNT = 5; 

        // Consolidated Skill Data (Updated from original list)
        const SKILL_DATA = [
            { name: "HTML", percent: 95, color: '#ff8c00' }, 
            { name: "CSS/SASS", percent: 85, color: '#ff8c00' },
            { name: "TAILWIND/BOOSTRAP", percent: 90, color: '#ff8c00' },
            { name: "JAVASCRIPT (ES6+)", percent: 95, color: '#00ff00' },
            { name: "REACT/NEXT.JS", percent: 80, color: '#00ff00' },
            { name: "TYPESCRIPT", percent: 75, color: '#00ff00' },
            { name: "NODE/EXPRESS", percent: 70, color: '#ffff00' },
            { name: "PHP/LARAVEL", percent: 70, color: '#ffff00' },
            { name: "FIREBASE/MONGO", percent: 85, color: '#ff0000' },
            { name: "GIT/CI/CD", percent: 90, color: '#00ff00' },
        ];

        // --- State Variables ---
        let mouseX = 0;
        let mouseY = 0;
        let lastBulletTime = 0;
        let bullets = [];
        let targets = []; 
        let totalTargets = 0;
        let destroyedTargets = 0;
        let gameOver = false;
        let hideTimeout;
        let spreadShotActive = false;
        let isFiring = true; 
        
        /**
         * 1. Populate the skill card with destructible percentage targets (in the new dedicated section).
         */
        function setupSkillsMatrixSection() {
            // Remove old skill targets if they exist from a previous run
            targets = targets.filter(span => !span.closest('#skill-list')); 
            skillListElement.innerHTML = ''; 

            SKILL_DATA.forEach(skill => {
                const skillLine = document.createElement('div');
                skillLine.className = `skill-item chaotic-skill destructible-text max-type-skill-label`;
                skillLine.style.animationDelay = `-${Math.random()}s`;

                // Non-destructible name (Maroon text on Khaki section)
                const nameContainer = document.createElement('div');
                nameContainer.className = 'skill-name text-[var(--color-maroon)]';
                nameContainer.textContent = `${skill.name}`;
                skillLine.appendChild(nameContainer);

                // Destructible part (Percentage)
                const percentContainer = document.createElement('div');
                percentContainer.className = 'skill-percent';

                const destructibleText = `${skill.percent}%`;
                destructibleText.split('').forEach(char => {
                    const span = document.createElement('span');
                    span.textContent = char === ' ' ? '\u00A0' : char; 
                    span.dataset.destroyed = 'false';
                    span.style.color = skill.color; 
                    
                    percentContainer.appendChild(span);
                    
                    if (char !== ' ') {
                        targets.push(span); // Add new targets
                    }
                });

                skillLine.appendChild(percentContainer);
                skillListElement.appendChild(skillLine);
            });
            
            // Re-calculate total targets after adding skill targets
            totalTargets = targets.length;
            destroyedTargets = targets.filter(span => span.dataset.destroyed === 'true').length;
            updateHealthBar();
        }


        /**
         * 2. Pre-process text and wrap every letter in a <span> across ALL non-skill sections.
         */
        function initializeTargets() {
            // Target all elements marked as destructible across the whole page *except* the skill list
            document.querySelectorAll(`.destructible-text`).forEach(element => {
                // If the element is the skill list container or already has children, skip it
                if (element.id === 'skill-list' || element.children.length > 0) return;

                const textContent = element.textContent.trim();
                element.innerHTML = ''; 
                
                textContent.split('').forEach(char => {
                    const span = document.createElement('span');
                    span.textContent = char === ' ' ? '\u00A0' : char; 
                    span.dataset.destroyed = 'false';
                    element.appendChild(span);
                    
                    if (char !== ' ') {
                        // Apply different color based on section background
                        const isKhakiSection = element.closest('#skills-matrix') || element.closest('#contact');
                        span.style.color = isKhakiSection ? 'var(--color-maroon)' : 'var(--color-khaki)';
                        targets.push(span);
                    }
                });
            });

            // Recalculate total targets based on all spans now present
            totalTargets = targets.length;
            destroyedTargets = targets.filter(span => span.dataset.destroyed === 'true').length; 
            updateHealthBar();
        }

        /**
         * 3. Health Bar and Game State Management
         */
        function updateHealthBar() {
            if (totalTargets === 0) return;

            const remainingPercentage = 100 - ((destroyedTargets / totalTargets) * 100);
            
            // Clamp value between 0 and 100
            const clampedPercentage = Math.max(0, remainingPercentage);
            
            healthFillElement.style.width = `${clampedPercentage}%`; 
            
            // Use background property for simplicity over background-color
            if (clampedPercentage < 25) {
                healthFillElement.style.background = 'var(--color-danger)'; 
            } else if (clampedPercentage < 50) {
                 healthFillElement.style.background = '#ffff00'; // Yellow
            } else {
                healthFillElement.style.background = 'var(--color-safe)';
            }

            // Check for Game Over condition
            if (destroyedTargets >= totalTargets && !gameOver) {
                gameOver = true;
                triggerGlitchEffect();
            }
        }

        // --- PROJECT PREVIEW FUNCTIONS (Hover Hologram) ---
        function showPreview(event, imageUrl) {
            if (gameOver) return;
            clearTimeout(hideTimeout);
            previewImage.src = imageUrl;
            
            const offsetX = 40; 
            const offsetY = 40; 
            
            let newX = mouseX + offsetX;
            let newY = mouseY + offsetY;

            const previewWidth = previewBox.offsetWidth || 416; 
            if (newX + previewWidth > window.innerWidth) {
                newX = mouseX - previewWidth - offsetX;
            }

            const previewHeight = previewBox.offsetHeight || 300; 
            if (newY + previewHeight > window.innerHeight) {
                newY = window.innerHeight - previewHeight - 10; 
            }
            
            projectPreview.style.left = `${newX}px`;
            projectPreview.style.top = `${newY}px`;
            
            projectPreview.classList.remove('hidden');
            setTimeout(() => { projectPreview.style.opacity = '1'; }, 10); 
        }

        function hidePreview() {
            clearTimeout(hideTimeout);
            hideTimeout = setTimeout(() => {
                projectPreview.style.opacity = '0';
                setTimeout(() => {
                    projectPreview.classList.add('hidden');
                }, 200); 
            }, 50);
        }
        
        // --- SKILL IMPLEMENTATIONS (Keys 1, 2, 3) ---

        function toggleSkillButtonVisual(skillId, isActive) {
            const skillEl = document.getElementById(skillId);
            if (!skillEl) return;
            
            if (isActive) {
                skillEl.classList.add('on');
            } else {
                skillEl.classList.remove('on');
            }
        }

        function toggleSpreadShot() {
            spreadShotActive = !spreadShotActive;
            document.getElementById('skill-1').textContent = `[1] SPREAD: ${spreadShotActive ? 'ON' : 'OFF'}`;
            toggleSkillButtonVisual('skill-1', spreadShotActive);
            lastBulletTime = 0; 
        }

        function repairTargets() {
            if (destroyedTargets === 0) return;

            const skillEl = document.getElementById('skill-2');
            skillEl.classList.add('pressed');
            setTimeout(() => {
                skillEl.classList.remove('pressed');
                explosionFlash.classList.remove('do-explosion'); 
            }, 500);

            explosionFlash.classList.add('do-explosion');
            
            const repairCount = Math.ceil(totalTargets * (REPAIR_AMOUNT / 100));
            
            // Repair newest (visually bottom) targets first
            const destroyedSpans = targets.filter(span => span.dataset.destroyed === 'true').reverse();
            const spansToRepair = destroyedSpans.slice(0, Math.min(repairCount, destroyedSpans.length));
            
            spansToRepair.forEach(span => {
                span.classList.remove('destroyed');
                span.dataset.destroyed = 'false';
                destroyedTargets--; 
            });

            updateHealthBar();
        }

        function toggleGunActive() {
            isFiring = !isFiring;
            document.getElementById('skill-3').textContent = `[3] GUN: ${isFiring ? 'ACTIVE' : 'OFF'}`;
            toggleSkillButtonVisual('skill-3', isFiring); 
        }

        /**
         * 4. Shatter Effect
         */
        function triggerShatter(x, y) {
            const pieceCount = 8;
            for (let i = 0; i < pieceCount; i++) {
                const piece = document.createElement('div');
                piece.className = 'shatter-piece';
                
                piece.style.left = `${x}px`;
                piece.style.top = `${y}px`;
                
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 30 + 10;
                
                setTimeout(() => {
                    piece.style.opacity = '0';
                    piece.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) rotate(${Math.random() * 360}deg)`;
                }, 10);

                confettiContainer.appendChild(piece); 
                setTimeout(() => piece.remove(), 550);
            }
        }
        
        /**
         * 5. Victory Glitch Effect 
         */
        function triggerGlitchEffect() {
            const glitchEl = document.getElementById('victory-glitch');
            if (!glitchEl) return;
            
            glitchEl.classList.add('rainbow-glitch-active');

            setTimeout(() => {
                glitchEl.classList.remove('rainbow-glitch-active');
            }, 5000); 
        }

        /**
         * 6. Cursor Tracking & Bullet Creation/Game Loop
         */
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            planeCursor.style.transform = `translate(${mouseX}px, ${mouseY}px)`;
        });
        
        document.addEventListener('keydown', (e) => {
            if (gameOver) return;

            switch (e.key) {
                case '1':
                    toggleSpreadShot();
                    break;
                case '2':
                    repairTargets();
                    break;
                case '3':
                    toggleGunActive(); 
                    break;
            }
        });
        
        // --- HUD Click Listeners (for mobile/touch) ---
        document.getElementById('skill-1').addEventListener('click', toggleSpreadShot);
        document.getElementById('skill-2').addEventListener('click', repairTargets);
        document.getElementById('skill-3').addEventListener('click', toggleGunActive);


        function createBullet() {
            if (gameOver || !isFiring) return; 
            
            // Firing angles (in radians: -10 deg, 0 deg, +10 deg)
            const angles = spreadShotActive ? [-0.174, 0, 0.174] : [0]; 
            
            // FIXED SHOOTING ALIGNMENT: Start point aligned to the plane's nose (16px up, 4px left for 8px bullet)
            const startX = mouseX - 4; 
            const startY = mouseY - 16; 

            for (let i = 0; i < angles.length; i++) {
                const angle = angles[i];
                const bullet = document.createElement('div');
                bullet.className = 'bullet';
                
                bullet.style.left = `${startX}px`;
                bullet.style.top = `${startY}px`;

                const vx = Math.sin(angle) * BULLET_SPEED; 
                const vy = -Math.cos(angle) * BULLET_SPEED;
                
                const bulletObj = {
                    el: bullet,
                    x: startX,
                    y: startY,
                    vx: vx,
                    vy: vy
                };
                
                bullets.push(bulletObj);
                bulletContainer.appendChild(bullet);
            }
        }

        function gameLoop(currentTime) {
            requestAnimationFrame(gameLoop);

            const currentFireRate = spreadShotActive ? FIRE_RATE * 1.5 : FIRE_RATE;

            if (isFiring && currentTime - lastBulletTime > currentFireRate) {
                createBullet();
                lastBulletTime = currentTime;
            }
            
            bullets = bullets.filter(bullet => {
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                bullet.el.style.left = `${bullet.x}px`;
                bullet.el.style.top = `${bullet.y}px`;

                if (bullet.y < 0) {
                    bullet.el.remove();
                    return false; 
                }

                let hit = false;
                for (let i = 0; i < targets.length; i++) {
                    const targetSpan = targets[i];
                    
                    if (targetSpan.dataset.destroyed === 'true') continue;

                    const rect = targetSpan.getBoundingClientRect();
                    const bulletSize = 8;
                    const collision = (
                        bullet.x < rect.right &&
                        bullet.x + bulletSize > rect.left &&
                        bullet.y < rect.bottom &&
                        bullet.y + bulletSize > rect.top
                    );
                    
                    if (collision) {
                        targetSpan.classList.add('destroyed');
                        targetSpan.dataset.destroyed = 'true';
                        
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        triggerShatter(centerX, centerY);

                        destroyedTargets++;
                        updateHealthBar();
                        
                        bullet.el.remove();
                        hit = true;
                        
                        break; 
                    }
                }

                return !hit; 
            });
        }

        // Initialize targets (all phases now combined) and start the game loop on load
        window.onload = () => {
             // Glitching text content toggle
            let isDev = true;
            if (glitchTitleEl) {
                setInterval(() => {
                    isDev = !isDev;
                    glitchTitleEl.textContent = isDev ? 'DEV' : 'DESIGNER';
                }, 1200); 
            }

            // Setup new continuous scroll flow
            setupSkillsMatrixSection(); 
            initializeTargets(); 
            
            requestAnimationFrame(gameLoop);
        };

    </script>
</body>
</html>