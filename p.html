<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leroza.dev - Retro Portfolio [CRT v2]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Retro Terminal Font -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        /* Define Custom Colors for Theme */
        :root {
            --color-khaki: #C3B091; /* Aged Amber/Terminal Main Color */
            --color-maroon: #500000; /* Deep Background Accent */
            --color-black: #000000;
            --color-white: #FFFFFF;
            --color-orange: #ff8c00; /* Action/Highlight Color */
            --color-danger: #ff0000;
            --color-safe: #00ff00;
        }

        /*
        * 1. Global Reset & Scroll Snap Setup (Retro Font Applied)
        */
        body {
            cursor: none; /* Hide default cursor */
            font-family: 'VT323', monospace;
            background-color: var(--color-black); /* True black background for CRT effect */
            color: var(--color-khaki); /* Main text color */
            height: 100vh;
            /* Scroll ability maintained by browser auto-overflow */
            scroll-snap-type: y mandatory;
            padding-bottom: 70px;
            position: relative;
        }

        section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: start;
            padding: 2rem;
            /* Retro glow/shadow: stronger glow on the text */
            text-shadow: 0 0 5px var(--color-khaki), 0 0 10px rgba(195, 176, 145, 0.4);
        }

        /* ----------------------------------------------------
        * NEW: CRT SCREEN OVERLAY (Scanlines, Curvature, Bloom)
        * ---------------------------------------------------- */
        #crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10000;
            opacity: 0.9;
            /* Curvature, subtle vignette, and black edges */
            box-shadow: 
                inset 0 0 100px rgba(0,0,0,0.7), /* Vignette */
                0 0 10px rgba(0, 0, 0, 0.8);
            background: 
                /* Scanlines */
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.2),
                    rgba(0, 0, 0, 0.3) 1px,
                    transparent 1px,
                    transparent 2px
                );
            /* Subtle RGB separation/bloom */
            filter: blur(0.3px) contrast(1.1);
            /* Curvature effect */
            transform: perspective(1000px) rotateX(0deg) rotateY(0deg); 
        }


        /*
        * 2. The Pixel Plane Cursor (Now Khaki)
        */
        #plane-cursor {
            position: fixed;
            width: 16px; /* Increased size for visibility */
            height: 16px;
            pointer-events: none;
            z-index: 10001;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            transition: transform 0.05s linear;
        }
        
        .plane-body {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background-color: var(--color-khaki); /* Plane body matches terminal color */
            box-shadow: 
                /* Wings */
                -8px 0 var(--color-khaki), 8px 0 var(--color-khaki),
                /* Nose/Firing Port */
                0 -8px var(--color-khaki), 0 -12px var(--color-white), /* White tip for bullet fire */
                /* Tail */
                0 8px var(--color-khaki); 
            transform: translate(-50%, -50%);
        }

        /*
        * 3. Bullet Styling (Orange Dot - Brighter Glow)
        */
        .bullet {
            position: fixed;
            width: 8px;
            height: 8px;
            background-color: var(--color-orange); 
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 0 10px var(--color-orange), 0 0 30px var(--color-orange); /* Stronger glow */
            opacity: 1;
            transition: opacity 0.1s;
        }

        /*
        * 4. Text Spans (Destructible Targets)
        */
        .destructible-text span {
            display: inline-block;
            transition: opacity 0.3s, transform 0.3s, color 0.1s;
            line-height: 1.2;
            will-change: transform, color;
        }
        
        /* Lively Hover Effect */
        .destructible-text span:hover {
            transform: translateY(-2px) scale(1.05);
            color: var(--color-orange); 
            z-index: 10;
        }

        .destroyed {
            opacity: 0 !important;
            transform: scale(0.5) translateY(-20px);
        }

        /*
        * 4.1. Chaotic Animation for Skills
        */
        @keyframes gruggyWobble {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            25% { transform: translate(-1px, 0px) rotate(-0.5deg); }
            50% { transform: translate(1px, -1px) rotate(0.5deg); }
            75% { transform: translate(-1px, 1px) rotate(-0.2deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        .chaotic-skill {
            animation: gruggyWobble 1s infinite alternate;
        }
        
        /*
        * 4.2. Explosion Flash Animation
        */
        @keyframes flashExplosion {
            0% { opacity: 0; background-color: transparent; }
            5% { opacity: 1; background-color: var(--color-orange); }
            10% { opacity: 1; background-color: var(--color-white); }
            20% { opacity: 0; background-color: transparent; }
            100% { opacity: 0; background-color: transparent; }
        }

        #explosion-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10002;
            pointer-events: none;
            opacity: 0;
        }
        .do-explosion {
            animation: flashExplosion 0.5s forwards;
        }

        /*
        * 4.3. Card Drop/Bounce Animation and Initial State Fix
        */
        @keyframes cardDrop {
            0% { transform: translateY(-100vh); opacity: 0; }
            60% { transform: translateY(0); opacity: 1; }
            80% { transform: translateY(-20px); }
            100% { transform: translateY(0); }
        }
        .do-card-drop {
            display: block !important; 
            animation: cardDrop 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            animation-delay: 0.5s;
        }

        .card-initial-state {
            opacity: 0;
            transform: translateY(-100vh);
            display: none;
        }
        
        /* ----------------------------------------------------
        * 5. Retro Life Bar / HUD Styles (Chunky & Bezel)
        * ---------------------------------------------------- */
        .hud-bar {
            /* Use khaki borders for a chunky bezel look */
            border-top: 6px solid var(--color-khaki);
            border-bottom: 6px solid var(--color-khaki);
            background-color: var(--color-maroon);
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.5); /* Subtle Orange Glow */
        }
        
        .health-bar-frame {
            border: 3px solid var(--color-khaki); /* Khaki frame */
            background-color: var(--color-black); /* Black background */
            height: 18px;
            width: 100%;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.8);
        }

        .health-bar-fill {
            height: 100%;
            /* Use a gradient to simulate segments and make it look more powerful */
            background: linear-gradient(to right, var(--color-danger) 0%, #ffff00 50%, var(--color-safe) 100%);
            transition: width 0.5s;
            /* Ensure fill starts from the left */
            transform-origin: left;
        }

        /* 5.1 SKILLS HUD BUTTON STYLES (Embedded Look) */
        .skill-button {
            display: inline-block;
            border: 3px solid var(--color-khaki); /* Frame border */
            background-color: var(--color-maroon);
            color: var(--color-khaki);
            padding: 2px 6px;
            /* Outset effect (simulating raised button) */
            box-shadow: 2px 2px 0 var(--color-black), -2px -2px 0 var(--color-maroon);
            transition: box-shadow 0.1s ease-in-out, background-color 0.1s;
        }

        /* Pressed/Repair Look (Key 2) */
        .skill-button:active, .skill-button.pressed {
            background-color: var(--color-orange); 
            color: var(--color-white);
            /* Inset effect (simulating pressed button) */
            box-shadow: inset 2px 2px 0 var(--color-black), inset -2px -2px 0 var(--color-white);
        }

        /* Toggle ON Look (Key 1, Key 3) */
        .skill-button.on {
            background-color: var(--color-white);
            color: var(--color-maroon);
            box-shadow: 0 0 8px var(--color-orange); /* Glowing effect */
        }

        /*
        * 5.2 Folder Item Styling
        */
        .folder-item {
            font-size: 2.5rem; /* Large text for retro feel */
            padding: 8px;
            color: var(--color-maroon); /* Text color in khaki section */
            transition: color 0.1s, background-color 0.1s;
            cursor: pointer;
            width: 100%; /* Ensure it fills the container */
            display: block;
            border-bottom: 2px dashed rgba(80, 0, 0, 0.3);
        }

        .folder-item:hover {
            color: var(--color-white); /* Highlight text on hover */
            background-color: rgba(80, 0, 0, 0.6); /* Maroon background highlight */
            text-shadow: 0 0 5px var(--color-white);
        }
        
        /* ----------------------------------------------------
        * 6. Preview and Glitch Effects
        * ---------------------------------------------------- */

        /* Project Preview Hologram Box */
        #project-preview {
            position: fixed;
            top: 0;
            left: 0;
            /* Ensure the preview stays above the HUD, but below the cursor */
            z-index: 9990; 
            pointer-events: none; /* Crucial: allows clicking through the overlay */
            transition: opacity 0.2s ease-out;
        }
        #preview-box {
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.8); /* Orange glow for hologram effect */
            width: 400px; /* Fixed width for consistency */
        }

        .shatter-piece {
            position: fixed;
            width: 2px;
            height: 2px;
            background-color: var(--color-khaki); 
            pointer-events: none;
            z-index: 10001; 
            opacity: 1;
            transition: transform 0.5s linear, opacity 0.5s ease-out;
        }

        /* 6.1 Victory Glitch Effect */
        @keyframes rainbowFlicker {
            0% { box-shadow: 0 0 20px 5px rgba(255, 0, 0, 0.9); }
            10% { box-shadow: 0 0 25px 8px rgba(255, 165, 0, 0.9); }
            20% { box-shadow: 0 0 30px 10px rgba(255, 255, 0, 0.9); }
            30% { box-shadow: 0 0 20px 5px rgba(0, 255, 0, 0.9); }
            40% { box-shadow: 0 0 25px 8px rgba(0, 0, 255, 0.9); }
            50% { box-shadow: 0 0 30px 10px rgba(75, 0, 130, 0.9); }
            60% { box-shadow: 0 0 20px 5px rgba(148, 0, 211, 0.9); }
            70% { box-shadow: 0 0 25px 8px rgba(255, 0, 0, 0.9); }
            80% { box-shadow: 0 0 30px 10px rgba(255, 255, 255, 0.9); }
            90% { box-shadow: 0 0 20px 5px rgba(255, 140, 0, 0.9); }
            100% { box-shadow: 0 0 20px 5px rgba(255, 0, 0, 0.9); }
        }
        
        #victory-glitch {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 10003; /* Higher than cursor and explosion */
            box-shadow: inset 0 0 0 0 transparent; /* Initial state (inset for edge effect) */
            /* Add an inset glow for the edge effect */
            filter: drop-shadow(0 0 50px rgba(255, 255, 255, 0.5));
            transition: box-shadow 0.1s linear;
        }

        .rainbow-glitch-active {
            /* We use a large inset box-shadow to simulate an edge glow that glitches */
            box-shadow: 
                inset 0 0 0 500px transparent, /* Main transparent fill */
                inset 0 0 50px 10px; /* Base glow */
            animation: rainbowFlicker 0.2s infinite steps(1); /* Fast flicker */
        }


        /* Phase 2 Skill Card Styling - Chunky Border Look */
        #skill-card-container {
            box-shadow: 0 0 20px rgba(195,176,145,0.8), 0 0 5px rgba(255,255,255,0.8);
            max-width: 90%;
            /* Use the same chunky border style as the HUD */
            border: 6px solid var(--color-khaki);
            background-color: var(--color-maroon);
            position: relative;
            overflow: hidden; 
        }
        .skill-name {
            color: var(--color-white);
            margin-right: 1.5rem; 
            display: inline-block;
        }
    </style>
</head>
<body>

    <!-- CRT Overlay for Scanlines and Curvature Effect -->
    <div id="crt-overlay" aria-hidden="true"></div>

    <!-- The Custom Plane Cursor -->
    <div id="plane-cursor" aria-hidden="true">
        <div class="plane-body"></div>
    </div>

    <!-- Bullet Container -->
    <div id="bullet-container"></div>

    <!-- Confetti Container (Kept for shatter effect pieces) -->
    <div id="confetti-container"></div>
    
    <!-- Explosion Flash Overlay -->
    <div id="explosion-flash"></div>

    <!-- Victory Glitch Overlay -->
    <div id="victory-glitch"></div>

    <!-- NEW: Project Preview Overlay (Fixed to screen) -->
    <div id="project-preview" class="fixed top-0 left-0 hidden z-20 pointer-events-none opacity-0">
        <div id="preview-box" class="p-2 border-4 border-[var(--color-orange)] bg-[var(--color-black)] text-[var(--color-khaki)] shadow-lg" style="width: 400px;">
            <p class="text-xl mb-2 text-center border-b border-[var(--color-khaki)]">FILE_PREVIEW.IMG</p>
            <!-- Placeholder image will be set by JS -->
            <img id="preview-image" src="" alt="Project Preview Placeholder" class="w-full h-auto" onerror="this.onerror=null;this.src='https://placehold.co/400x250/ff0000/ffffff?text=ERROR'; document.getElementById('preview-box').style.width='400px'">
        </div>
    </div>

    <!-- Header / LIFEBAR HUD (Fixed to the BOTTOM) -->
    <header id="hud-bar" class="fixed bottom-0 left-0 right-0 z-50 p-3 hud-bar">
        <nav class="flex justify-between items-center max-w-7xl mx-auto w-full text-lg">
            
            <!-- Group 1 (Left: Player Name) -->
            <div class="text-xl md:text-2xl font-bold text-[var(--color-khaki)] tracking-widest border-b-4 border-b-[var(--color-orange)] pb-1 hidden sm:block">
                PLAYER: LEROZA
            </div>

            <!-- Group 2 (Center: HP & Skills) -->
            <div class="flex items-center space-x-4 md:space-x-6 mx-auto md:mx-0">
                
                <!-- Health Bar Visual -->
                <div class="flex items-center space-x-2">
                    <span class="text-xl text-[var(--color-khaki)]">TARGETS:</span>
                    <div class="health-bar-frame w-20 md:w-28">
                        <div id="health-fill" class="health-bar-fill" style="width: 100%;"></div>
                    </div>
                </div>

                <!-- Skills HUD -->
                <div id="skills-hud" class="hidden sm:flex space-x-2 text-sm font-bold">
                    <span id="skill-1" class="skill-button cursor-pointer on">[1] SPREAD: OFF</span>
                    <span id="skill-2" class="skill-button cursor-pointer">[2] REPAIR (5%)</span>
                    <span id="skill-3" class="skill-button cursor-pointer on">[3] GUN: ACTIVE</span>
                </div>
            </div>

            <!-- Group 3 (Right: Navigation Links) -->
            <div class="flex space-x-4 md:space-x-6 text-base font-bold">
                <a href="#intro" class="text-[var(--color-khaki)] hover:text-[var(--color-orange)] transition duration-200">[ HOME ]</a>
                <a href="#work" class="text-[var(--color-khaki)] hover:text-[var(--color-orange)] transition duration-200">[ PROJECTS ]</a>
                <a href="#contact" class="text-[var(--color-khaki)] hover:text-[var(--color-orange)] transition duration-200">[ CONNECT ]</a>
            </div>
        </nav>
    </header>

    <!-- SECTION 1: INTRO (Maroon Background) - PHASE 1 & PHASE 2 Containers -->
    <section id="intro" class="bg-[var(--color-maroon)]">
        <div class="text-center max-w-4xl px-4">
            
            <!-- PHASE 1: Initial Screen -->
            <div id="mission-start-screen" class="space-y-8">
                <h2 class="text-7xl md:text-8xl font-extrabold text-[var(--color-khaki)] destructible-text" data-phase="1">
                    MISSION FILE.
                </h2>
                <p class="text-3xl md:text-5xl font-light text-[var(--color-white)] destructible-text" data-phase="1">
                    SCAN TO CONTINUE.
                </p>
            </div>
            
            <!-- PHASE 2: SKILLS CARD -->
            <div id="skill-card-container" class="card-initial-state text-left w-full md:w-[800px] p-6 bg-[var(--color-maroon)] relative">
                <h3 class="4xl font-extrabold text-[var(--color-khaki)] mb-6 border-b-4 border-b-[var(--color-khaki)] pb-2">SKILL_MATRIX // RATING</h3>
                
                <div id="skill-list" class="grid grid-cols-2 gap-x-12 gap-y-4">
                    <!-- Skills will be populated here by JS upon Phase 1 completion -->
                </div>

                <p class="xl md:text-2xl font-extralight text-[var(--color-khaki)] mt-8">
                    TARGET PERCENTAGES.
                </p>
            </div>
        </div>
    </section>

    <!-- SECTION 2: WORK (Khaki Background) - Updated to Folder Format -->
    <section id="work" class="bg-[var(--color-khaki)]">
        <div class="text-center max-w-5xl px-4 text-[var(--color-maroon)]">
            <h2 class="7xl md:text-9xl font-extrabold mb-4 destructible-text" data-phase="2">
                PROJECT_LOG
            </h2>
            <!-- New Folder List Structure -->
            <div id="project-folder-list" class="mt-12 text-left max-w-2xl mx-auto space-y-1 md:space-y-2">
                
                <div class="folder-item destructible-text" data-phase="2" 
                     onmouseover="showPreview(event, 'https://placehold.co/400x250/500000/C3B091?text=GAME+UI+SCREENSHOT')"
                     onmouseout="hidePreview()">
                    > [DIR] GAME\_UI\_V1 (2024)
                </div>
                
                <div class="folder-item destructible-text" data-phase="2" 
                     onmouseover="showPreview(event, 'https://placehold.co/400x250/C3B091/500000?text=WEB+APP+DASHBOARD')"
                     onmouseout="hidePreview()">
                    > [DIR] WEB\_APP\_V2 (2023)
                </div>
                
                <div class="folder-item destructible-text" data-phase="2" 
                     onmouseover="showPreview(event, 'https://placehold.co/400x250/ff8c00/FFFFFF?text=3D+MODEL+RENDER')"
                     onmouseout="hidePreview()">
                    > [DIR] 3D\_ASSETS\_PACK (2022)
                </div>
                
                <div class="folder-item destructible-text" data-phase="2" 
                     onmouseover="showPreview(event, 'https://placehold.co/400x250/00ff00/500000?text=AI+BOT+INTEGRATION')"
                     onmouseout="hidePreview()">
                    > [FILE] AI\_ENGINE\_V1.EXE
                </div>
                
            </div>
        </div>
    </section>

    <!-- SECTION 3: CONTACT (Maroon Background) -->
    <section id="contact" class="bg-[var(--color-maroon)]">
        <div class="text-center max-w-4xl px-4">
            <h2 class="7xl md:text-9xl font-extrabold mb-4 text-[var(--color-khaki)] destructible-text" data-phase="2">
                GAME OVER.
            </h2>
            <p class="3xl md:text-5xl font-light text-[var(--color-white)] mt-8 destructible-text" data-phase="2">
                LEROZA@DEV.IO
            </p>
            <div class="mt-12">
                <!-- Contact Button: Hard lines, orange hover, inverse colors -->
                <a href="mailto:leroza@dev.io" class="inline-block px-8 py-4 text-2xl font-bold bg-[var(--color-khaki)] text-[var(--color-maroon)] rounded-none shadow-2xl border-4 border-white hover:bg-[var(--color-orange)] hover:text-white transition duration-300 transform hover:scale-105">
                    INITIATE_CONTACT
                </a>
            </div>
        </div>
    </section>

    <script>
        // --- Game Setup and Constants ---
        const planeCursor = document.getElementById('plane-cursor');
        const bulletContainer = document.getElementById('bullet-container');
        const healthFillElement = document.getElementById('health-fill');
        const confettiContainer = document.getElementById('confetti-container');
        const missionStartScreen = document.getElementById('mission-start-screen');
        const skillCardContainer = document.getElementById('skill-card-container');
        const skillListElement = document.getElementById('skill-list');
        const explosionFlash = document.getElementById('explosion-flash');
        
        // NEW Preview elements
        const projectPreview = document.getElementById('project-preview');
        const previewImage = document.getElementById('preview-image');
        const previewBox = document.getElementById('preview-box');

        const BULLET_SPEED = 10; 
        const FIRE_RATE = 50; 
        const REPAIR_AMOUNT = 5; // Percentage of destroyed targets to repair with Key 2

        const SKILL_DATA = [
            { name: "HTML", percent: 40 },
            { name: "CSS", percent: 30 },
            { name: "JS", percent: 50 },
            { name: "BOOTSTRAP", percent: 60 },
            { name: "TAILWIND", percent: 30 },
            { name: "PHP", percent: 70 },
        ];

        // --- State Variables ---
        let mouseX = 0;
        let mouseY = 0;
        let lastBulletTime = 0;
        let bullets = [];
        
        let targets = []; 
        let totalTargets = 0;
        let destroyedTargets = 0;
        let gamePhase = 1; 
        let gameOver = false;

        // NEW: Timeout variable for debouncing the hide action
        let hideTimeout;

        // --- Skill States ---
        let spreadShotActive = false;
        let isFiring = true; 
        
        /**
         * 1. Pre-process text and wrap every letter in a <span> for the current phase.
         */
        function initializeTargets() {
            targets.length = 0; // Clear targets for the new phase
            
            // Phase 1 targets only target the initial large text
            const elementsToTarget = document.querySelectorAll(`.destructible-text[data-phase="1"]`);
            
            elementsToTarget.forEach(element => {
                const textContent = element.textContent.trim();
                element.innerHTML = ''; 
                
                textContent.split('').forEach(char => {
                    const span = document.createElement('span');
                    span.textContent = char === ' ' ? '\u00A0' : char; 
                    span.dataset.destroyed = 'false';
                    element.appendChild(span);
                    if (char !== ' ') {
                        targets.push(span);
                    }
                });
            });

            // Set initial stats
            totalTargets = targets.length;
            destroyedTargets = 0;
            updateHealthBar();
            // Ensure HUD button states are set correctly on init
            toggleSkillButtonVisual('skill-1', spreadShotActive);
            toggleSkillButtonVisual('skill-3', isFiring);
        }

        /**
         * 2. Populate the skill card and set up Phase 2 targets (The skills percentages).
         */
        function setupSkillsCard() {
            // Clear existing targets (from phase 1 initial screen)
            targets.length = 0;
            skillListElement.innerHTML = ''; 

            // Populate and wrap the skill list with destructible percentages
            SKILL_DATA.forEach(skill => {
                const skillLine = document.createElement('p');
                // Apply chaotic-skill and destructible-text classes
                skillLine.className = `text-4xl font-light chaotic-skill destructible-text`;
                skillLine.style.animationDelay = `-${Math.random()}s`;

                // Non-destructible name and separator (white)
                const name = document.createElement('span');
                name.className = 'skill-name';
                name.textContent = `${skill.name} // `;
                skillLine.appendChild(name);

                // Destructible part (Percentage - khaki, to be destroyed)
                const destructibleText = `${skill.percent}%`;
                destructibleText.split('').forEach(char => {
                    const span = document.createElement('span');
                    span.textContent = char === ' ' ? '\u00A0' : char; 
                    span.dataset.destroyed = 'false';
                    span.style.color = 'var(--color-khaki)'; /* Make percentage khaki */
                    skillLine.appendChild(span);
                    
                    if (char !== ' ') {
                        targets.push(span); // Add new targets
                    }
                });
                skillListElement.appendChild(skillLine);
            });
            
            // Set phase 2 state
            totalTargets = targets.length;
            destroyedTargets = 0;
            updateHealthBar();
        }

        /**
         * 3. Handles the transition from Phase 1 to Phase 2, including the explosion and card drop.
         */
        function transitionToSkills() {
            // 1. Trigger Explosion
            explosionFlash.classList.add('do-explosion');
            
            // 2. Hide Phase 1 screen immediately
            missionStartScreen.classList.add('hidden');
            
            // 3. Setup skills content while hidden
            setupSkillsCard();

            // 4. Reveal card and trigger drop animation
            skillCardContainer.classList.remove('card-initial-state'); 
            skillCardContainer.classList.add('do-card-drop');
            
            // 5. Cleanup explosion class after animation completes
            setTimeout(() => {
                explosionFlash.classList.remove('do-explosion');
            }, 500);

            // 6. Change game phase after card drop finishes
            setTimeout(() => {
                gamePhase = 2;
                // Re-initialize all other phase 2 targets (work/contact text)
                initializePortfolioTargets(); 
            }, 1200); 
        }

        /**
         * 4. Initializes targets for the rest of the portfolio (Sections 2 and 3).
         */
        function initializePortfolioTargets() {
            // Add all Phase 2 targets to the existing 'targets' array (which already contains the skill percentages)
            // Select all elements with the specific data-phase, including the new .folder-item elements
            document.querySelectorAll(`.destructible-text[data-phase="2"]`).forEach(element => {
                // Only process elements that haven't been processed yet (those without spans)
                if (element.children.length > 0 && element.children[0].tagName === 'SPAN') {
                    // Already processed (from skill card)
                    return; 
                }
                
                const textContent = element.textContent.trim();
                element.innerHTML = '';
                
                textContent.split('').forEach(char => {
                    const span = document.createElement('span');
                    span.textContent = char === ' ' ? '\u00A0' : char; 
                    span.dataset.destroyed = 'false';
                    // Apply different color based on section (khaki text on maroon, maroon text on khaki)
                    const isKhakiSection = element.closest('#work');
                    span.style.color = isKhakiSection ? 'var(--color-maroon)' : 'var(--color-khaki)';
                    
                    element.appendChild(span);
                    if (char !== ' ') {
                        targets.push(span);
                    }
                });
            });

            // Update stats for the final phase
            totalTargets = targets.length;
            // destroyedTargets remains the same (targets destroyed in Phase 1)
        }
        
        /**
         * 5. Health Bar and Game State Management
         */
        function updateHealthBar() {
            if (totalTargets === 0) return;

            const remainingPercentage = 100 - ((destroyedTargets / totalTargets) * 100);
            
            // Clamp value between 0 and 100
            const clampedPercentage = Math.max(0, remainingPercentage);
            
            healthFillElement.style.width = `${clampedPercentage}%`; 
            
            // Danger color thresholds
            if (clampedPercentage < 25) {
                healthFillElement.style.backgroundColor = 'var(--color-danger)'; 
            } else if (clampedPercentage < 50) {
                 healthFillElement.style.backgroundColor = '#ffff00'; // Yellow
            } else {
                healthFillElement.style.backgroundColor = 'var(--color-safe)';
            }

            // Check for Phase Transition / Game Over condition
            if (destroyedTargets >= totalTargets) {
                if (gamePhase === 1) {
                    transitionToSkills(); 
                } else if (gamePhase === 2 && !gameOver) {
                    gameOver = true;
                    // Replaced triggerConfetti() with the new glitch effect
                    triggerGlitchEffect();
                }
            }
        }

        // --- PROJECT PREVIEW FUNCTIONS (New) ---

        /**
         * Shows the project preview image near the cursor position.
         * @param {Event} event - The mouse event.
         * @param {string} imageUrl - The placeholder image URL.
         */
        function showPreview(event, imageUrl) {
            if (gameOver) return;

            // CRUCIAL: Clear any pending hide timeouts
            clearTimeout(hideTimeout);

            // 1. Set Image Source
            previewImage.src = imageUrl;
            
            // 2. Calculate offset (Image appears to the right of the cursor/plane)
            const offsetX = 30; // Distance to the right of the cursor
            const offsetY = 30; // Distance slightly below the cursor
            
            let newX = mouseX + offsetX;
            let newY = mouseY + offsetY;

            // Boundary Check (Prevent image from going off the right side)
            const previewWidth = previewBox.offsetWidth || 416; // Use actual width or default (400px + 2*8px padding)
            if (newX + previewWidth > window.innerWidth) {
                // Move to the left of the cursor instead
                newX = mouseX - previewWidth - offsetX;
            }

            // Boundary Check (Prevent image from going off the bottom)
            const previewHeight = previewBox.offsetHeight || 300; // Estimate height
            if (newY + previewHeight > window.innerHeight) {
                newY = window.innerHeight - previewHeight - 5; 
            }
            
            // 3. Apply position and show
            projectPreview.style.left = `${newX}px`;
            projectPreview.style.top = `${newY}px`;
            
            projectPreview.classList.remove('hidden');
            setTimeout(() => { projectPreview.style.opacity = '1'; }, 10); // Fade in (0.2s transition set in CSS)
        }

        /**
         * Hides the project preview image with a short delay to prevent flickering.
         */
        function hidePreview() {
            // Set a short delay (50ms) before hiding to debounce jittery mouse movements.
            clearTimeout(hideTimeout);
            hideTimeout = setTimeout(() => {
                projectPreview.style.opacity = '0';
                // Use a short delay before adding the 'hidden' class to allow CSS transition (0.2s)
                setTimeout(() => {
                    projectPreview.classList.add('hidden');
                }, 200); 
            }, 50);
        }
        
        // --- SKILL IMPLEMENTATIONS (Keys 1, 2, 3) ---

        function toggleSkillButtonVisual(skillId, isActive) {
            const skillEl = document.getElementById(skillId);
            if (!skillEl) return;
            
            if (isActive) {
                skillEl.classList.add('on');
            } else {
                skillEl.classList.remove('on');
            }
        }

        function toggleSpreadShot() {
            spreadShotActive = !spreadShotActive;
            document.getElementById('skill-1').textContent = `[1] SPREAD: ${spreadShotActive ? 'ON' : 'OFF'}`;
            toggleSkillButtonVisual('skill-1', spreadShotActive);
            lastBulletTime = 0; 
        }

        function repairTargets() {
            if (destroyedTargets === 0) return;

            // Visual feedback for Key 2
            const skillEl = document.getElementById('skill-2');
            skillEl.classList.add('pressed');
            setTimeout(() => {
                skillEl.classList.remove('pressed');
            }, 150);

            // Calculate the number of letters to repair (5% of total targets)
            const repairCount = Math.ceil(totalTargets * (REPAIR_AMOUNT / 100));
            
            const destroyedSpans = targets.filter(span => span.dataset.destroyed === 'true');
            const spansToRepair = destroyedSpans.slice(0, Math.min(repairCount, destroyedSpans.length));
            
            spansToRepair.forEach(span => {
                span.classList.remove('destroyed');
                span.dataset.destroyed = 'false';
                destroyedTargets--; 
            });

            updateHealthBar();
        }

        function toggleGunActive() {
            isFiring = !isFiring;
            document.getElementById('skill-3').textContent = `[3] GUN: ${isFiring ? 'ACTIVE' : 'OFF'}`;
            // Button is ON (lit) when gun is ACTIVE (can shoot)
            toggleSkillButtonVisual('skill-3', isFiring); 
        }

        /**
         * 6. Shatter Effect (Pure JS - generates small debris upon destruction)
         */
        function triggerShatter(x, y) {
            const pieceCount = 8;
            for (let i = 0; i < pieceCount; i++) {
                const piece = document.createElement('div');
                piece.className = 'shatter-piece';
                
                piece.style.left = `${x}px`;
                piece.style.top = `${y}px`;
                
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 30 + 10;
                
                setTimeout(() => {
                    piece.style.opacity = '0';
                    piece.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) rotate(${Math.random() * 360}deg)`;
                }, 10);

                confettiContainer.appendChild(piece); 
                setTimeout(() => piece.remove(), 550);
            }
        }
        
        /**
         * 7. Glitch Effect (Replaces confetti)
         */
        function triggerGlitchEffect() {
            const glitchEl = document.getElementById('victory-glitch');
            if (!glitchEl) return;
            
            // Start the infinite flicker animation
            glitchEl.classList.add('rainbow-glitch-active');

            // Stop the flicker after 5 seconds
            setTimeout(() => {
                glitchEl.classList.remove('rainbow-glitch-active');
            }, 5000); 
        }

        /**
         * 8. Cursor Tracking & Bullet Creation/Game Loop
         */
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            // Plane cursor tracks smoothly
            planeCursor.style.transform = `translate(${mouseX}px, ${mouseY}px)`;
        });
        
        // --- Global Key Listener for Skills ---
        document.addEventListener('keydown', (e) => {
            if (gameOver) return;

            switch (e.key) {
                case '1':
                    toggleSpreadShot();
                    break;
                case '2':
                    repairTargets();
                    break;
                case '3':
                    toggleGunActive(); 
                    break;
            }
        });
        
        // --- HUD Click Listeners (for mobile/touch) ---
        document.getElementById('skill-1').addEventListener('click', toggleSpreadShot);
        document.getElementById('skill-2').addEventListener('click', repairTargets);
        document.getElementById('skill-3').addEventListener('click', toggleGunActive);


        function createBullet() {
            if (gameOver || !isFiring) return; 
            
            const numBullets = spreadShotActive ? 3 : 1;
            const angles = spreadShotActive ? [-0.174, 0, 0.174] : [0]; 
            
            const startX = mouseX - 4; 
            const startY = mouseY - 20; 

            for (let i = 0; i < numBullets; i++) {
                const angle = angles[i];
                const bullet = document.createElement('div');
                bullet.className = 'bullet';
                
                bullet.style.left = `${startX}px`;
                bullet.style.top = `${startY}px`;

                const vx = Math.sin(angle) * BULLET_SPEED * 0.5; 
                const vy = -Math.cos(angle) * BULLET_SPEED;
                
                const bulletObj = {
                    el: bullet,
                    x: startX,
                    y: startY,
                    vx: vx,
                    vy: vy
                };
                
                bullets.push(bulletObj);
                bulletContainer.appendChild(bullet);
            }
        }

        function gameLoop(currentTime) {
            requestAnimationFrame(gameLoop);

            const currentFireRate = spreadShotActive ? FIRE_RATE * 1.5 : FIRE_RATE;

            if (currentTime - lastBulletTime > currentFireRate) {
                createBullet();
                lastBulletTime = currentTime;
            }
            
            bullets = bullets.filter(bullet => {
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;
                bullet.el.style.left = `${bullet.x}px`;
                bullet.el.style.top = `${bullet.y}px`;

                if (bullet.y < 0) {
                    bullet.el.remove();
                    return false; 
                }

                let hit = false;
                for (let i = 0; i < targets.length; i++) {
                    const targetSpan = targets[i];
                    
                    if (targetSpan.dataset.destroyed === 'true') continue;

                    const rect = targetSpan.getBoundingClientRect();
                    const bulletSize = 8;
                    const collision = (
                        bullet.x < rect.right &&
                        bullet.x + bulletSize > rect.left &&
                        bullet.y < rect.bottom &&
                        bullet.y + bulletSize > rect.top
                    );
                    
                    if (collision) {
                        targetSpan.classList.add('destroyed');
                        targetSpan.dataset.destroyed = 'true';
                        
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        triggerShatter(centerX, centerY);

                        destroyedTargets++;
                        updateHealthBar();
                        
                        bullet.el.remove();
                        hit = true;
                        
                        break; 
                    }
                }

                return !hit; 
            });
        }

        // Initialize targets (Phase 1) and start the game loop on load
        window.onload = () => {
            initializeTargets(); 
            requestAnimationFrame(gameLoop);
        };

    </script>
</body>
</html>
